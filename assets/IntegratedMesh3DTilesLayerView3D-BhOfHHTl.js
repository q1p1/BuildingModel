import{B as Fe,mi as pe,lc as G,ki as U,h3 as C,dC as Re,df as He,mj as Ve,l2 as je,L as De,mk as Le,I as Be,H as ge,e as J,ml as ke,E as be,P as Ge,mm as ye,u as fe,gs as Ne,j9 as _e,mn as $e,K as ze,d6 as We,bk as qe,bI as Je,h7 as Ke,mo as Xe,hT as Ye,hZ as we,mp as Ze,mq as K,mr as Qe,ms as et,bH as X,fd as tt,mt as st,mu as it,mv as ve,mw as rt,hh as at,dz as nt,hU as ot,ba as j,mx as lt,cK as ct,bm as dt,my as ht,mz as ut,mA as mt,bG as xe,h2 as pt,lh as gt,li as bt,lj as yt,hN as Y,ll as ft,ln as _t,d4 as D,mB as wt,mC as vt,mD as xt,mE as Ce,mF as Te,z as Me,r as I,m as L,a as Ct,bT as Pe}from"./index-Dr8Kof1t.js";import{x as Tt,f as Mt,t as Pt,i as Et}from"./Transform-DRXx2L7z.js";import{r as E,a as Z,S as B,N as O,e as p,m as Ot,d as Ut,g as Ee,t as M,n as Q,i as S}from"./ILyr3DWasmPerSceneView-KC8PJi3s.js";import{l as At}from"./LayerView3D-C0stEa_e.js";import{s as It}from"./RenderTexture-COKIC7aJ.js";import{y as St}from"./LayerView-DQxnzAhF.js";class Ft extends Fe{constructor(e,d,r,u,n,a,h){super(e,0,0,0,d),this.nodesCached=r,this.vboMB=u,this.textureMB=n,this.vboMBCached=a,this.textureMBCached=h}}const Rt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:pe.TRIANGLES,[E.TriangleStrip]:pe.TRIANGLE_STRIP,[E.NotSet]:null},Oe={[Z.Opaque]:G.Opaque,[Z.Mask]:G.Mask,[Z.Blend]:G.Blend},Ht={[B.Back]:U.Back,[B.Front]:U.Front,[B.None]:U.None,[B.NotSet]:U.Back},Vt={[O.WrapYBit]:{s:C.CLAMP_TO_EDGE,t:C.REPEAT},[O.WrapXBit]:{s:C.REPEAT,t:C.CLAMP_TO_EDGE},[O.WrapXy]:{s:C.REPEAT,t:C.REPEAT},[O.None]:{s:C.CLAMP_TO_EDGE,t:C.CLAMP_TO_EDGE},[O.NotSet]:{s:C.CLAMP_TO_EDGE,t:C.CLAMP_TO_EDGE}},jt={[p.U8]:1,[p.I8]:1,[p.U16]:2,[p.I16]:2,[p.U32]:4,[p.I32]:4,[p.F32]:4,[p.F64]:8,[p.Utf8String]:1,[p.NotSet]:1};class Dt{constructor(e){this.layerUid=[],this.type=Re.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,d,r,u,n,a){const h=e.results,v=e.options.store===He.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const f=this.layerView.view._stage.renderView.componentObjectCollection,g=new Ve(a??!1,e.options.normalRequired);this.layerView.objects.forEach(o=>{o.visible&&o.intersectionGeometry&&f.intersect(o,r,u,e.tolerance,null,g,(l,s,c,b)=>{if(s>=0){if(d!=null&&!d(r,u,s))return;const m=w=>{const _=new Le(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,s,c)};if(this.isGround&&(h.ground.dist==null||s<h.ground.dist)&&m(h.ground),e.options.isFiltered)return;if((h.min.dist==null||s<h.min.dist)&&m(h.min),(h.max.dist==null||s>h.max.dist)&&m(h.max),v){const w=je(e.ray);m(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,d){return new De({layer:e,sourceLayer:e,attributes:d})}}var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));class Lt{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}totalMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}}function k(t){return Math.round(t/1048.576)/1e3}let P=class extends At(St){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Be.WithoutRasterImage,this._applySSAO=!ge("disable-feature:im-ssao"),this._shadeNormals=!!ge("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new J("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=ke(this).then(e=>{this._intersectionHandler=new Dt(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,r=>this._slicePlaneEnabledChange(r)),this._elevationProvider=new Tt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const d=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,r=>this._onRemoveFromCache(r));this._memCache=d,this.addHandles([be(()=>this.layer.elevationInfo,r=>this._elevationInfoChanged(r))]),this._suspendedHandle=be(()=>this.suspended,r=>{var u;return(u=this._wasm)==null?void 0:u.setEnabled(this,!r)},Ge)}).catch(e=>{if(ye(this),this._wasmLayerId=-1,e===Ot)throw new J("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===Ut)throw new J("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),ye(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=fe(this._memCache),this._updatingHandles=fe(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??(this._visibleGeometryChangedSchedulerHandle=Ne(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const d=this._collection.getMaterial(e);d.commonMaterialParameters.hasSlicePlane=t,d.commonMaterialParameters.cullFace=t?U.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){var e;(e=this._wasm)==null||e.setLayerOffset(this,_e(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return $e(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.totalMemory())}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.totalMemory())}),t}get visibleAtCurrentScale(){return ze(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,d=0,r=0,u=0,n=0;return this._lyrHandleToObjects.forEach(a=>{a.isVisible?(t+=a.texMemoryUsage,e+=a.vboMemoryUsage,u++):(d+=a.texMemoryUsage,r+=a.vboMemoryUsage,n++)}),new Ft(this.usedMemory,u,n,k(e),k(t),k(r),k(d))}_canProjectWithoutEngine(){var t,e;if(this.view.state.viewingMode===We.Local){const d=(t=this.view.renderSpatialReference)!=null&&t.isWebMercator?3857:((e=this.view.renderSpatialReference)==null?void 0:e.wkid)??-1;if(d!==3857&&d!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return _e(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t!=null&&t.zmin&&(t!=null&&t.zmax)?new qe(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){var s;const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const d=Je(e.desc.origin),r=new Array,u=new Map,n=new Lt;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const a=this.view.basemapTerrain.spatialReference;let h,v;if(this.view.viewingMode==="global"){const c=Pe();Ke(Xe,d,c,a),h=Ye(we(),c),v=Ze(we(),h)}else h=K,v=K;const f=Pe();Qe(f,f,d);const g=et(X(),f);let o=null;const l=X();if(e.desc.obb){const c=e.desc.obb.quaternion;o=new tt(e.desc.obb.center,e.desc.obb.halfSize,st(c[0],c[1],c[2],c[3]))}for(let c=0;c<e.desc.prims.length;c++){const b=e.desc.prims[c];if(this._dbg(y.VerboseAPI,JSON.stringify(b)),Rt[b.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+b.ptype+"). Skipping primitive.");continue}const m=(s=e.desc)!=null&&s.materials&&b.materialId!=null?e.desc.materials[b.materialId]:null,w=m!=null?m.lightingModel:Ee.Unlit,{positionView:_,positionAttr:T,normalsView:Ue,normalsAttr:N,colorAttr:F,texCoord0Attr:R,indicesView:A}=this.getBufferViews(b,e.data.buffer,h);if(T==null||_==null||A==null)continue;const ee=new it(F!=null,R!=null?ve.Default:ve.None,Ue!=null,this._shadeNormals,this._applySSAO),Ae=T.data.length/T.size,$=(i,x)=>!i||i.data.length/i.size===Ae||(this._dbg(y.Error,`${x} !== numPos. Skipping primitive.`),!1);if(!$(R,"numTexcoord")||!$(F,"numColors")||!$(N,"normals"))continue;const te=rt(ee);if(o!=null?o=o.clone():(o=at(T),nt(l,o.center,d),o.center=l),h!==K)for(let i=0;i<_.count;i++)_.getVec(i,l),ot(l,l,h),_.setVec(i,l);const z=te.createBuffer(T.data.length),H=new Map([[j.POSITION,T]]);R!=null&&H.set(j.UV0,R),F!=null&&H.set(j.COLOR,F),N!=null&&H.set(j.NORMALCOMPRESSED,N),H.forEach((i,x)=>{i!=null&&lt(x,i,null,null,z,0)});const Ie=new Uint32Array([0,A.typedBuffer.length]),Se={vertices:{data:z.buffer,count:z.byteLength/te.stride,layoutParameters:ee},positionData:{positions:_.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Ie};n.cpuMemoryUsage+=_.count,n.cpuMemoryUsage+=A.count;const se=this.view.renderSpatialReference,W=X(),q=[1,1,1];Mt(g,se,q,a)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),ct(g,se,W,a);const V=this._collection.createObject(new Pt(dt(W[0],W[1],q[0],q[1]),new Et(g,v),o,Se));m&&this._collection.updateMaterial(V,i=>{i.baseColor=m.baseColorFactor,i.usePBR=w===Ee.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(m.baseColorTex,e,u),i.usePBR&&(i.mrrFactors=[m.metallicFactor,m.roughnessFactor,0],i.emissiveFactor=m.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(m.metalTex,e,u),i.emissionTexture=this._getTexture(m.emissiveTex,e,u),i.occlusionTexture=this._getTexture(m.occlusionTex,e,u),i.normalTexture=this._getTexture(m.normalTex,e,u)),i.objectOpacity=0,i.alphaDiscardMode=G.Mask;const x=[];i.baseColorTexture&&x.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&x.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&x.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&x.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&x.push(i.normalTexture.loadPromise);const ie=Promise.all(x);r.push(ie),ie.then(()=>{var re,ae,ne,oe,le,ce,de,he,ue,me;i.alphaDiscardMode=Oe[m.alphaMode],i.objectOpacity=1,n.texMemoryUsage+=((ae=(re=i.baseColorTexture)==null?void 0:re.glTexture)==null?void 0:ae.usedMemory)||0,i.usePBR&&(n.texMemoryUsage+=((oe=(ne=i.metallicRoughnessTexture)==null?void 0:ne.glTexture)==null?void 0:oe.usedMemory)||0,n.texMemoryUsage+=((ce=(le=i.emissionTexture)==null?void 0:le.glTexture)==null?void 0:ce.usedMemory)||0,n.texMemoryUsage+=((he=(de=i.occlusionTexture)==null?void 0:de.glTexture)==null?void 0:he.usedMemory)||0,n.texMemoryUsage+=((me=(ue=i.normalTexture)==null?void 0:ue.glTexture)==null?void 0:me.usedMemory)||0)}),i.commonMaterialParameters.doubleSided=m.isDoubleSided,i.commonMaterialParameters.cullFace=m.faceCulling?Ht[m.faceCulling]:U.Back,this._initialCullFace.set(V,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=ht.All,i.textureAlphaCutoff=m.alphaCutoff??ut,i.alphaDiscardMode=Oe[m.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=mt(this.view.spatialReference)}),n.components.push(V),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(V)}if(await Promise.all(r),u.forEach(c=>{n.textures.push(c)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n,n.totalMemory()),{memUsageBytes:n.totalMemory()}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(d=>{this._stage.remove(d)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,d){if(this._memCache){for(let r=0;r<d;++r){const u=t[r],n=e[r];if(!n)continue;const a=this._lyrHandleToObjects.get(u);a&&(this._visibleGeometryChanged(),a.isVisible=n,a.components.forEach(h=>{this._collection.setObjectVisibility(h,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.pop(`${u}`))}for(let r=0;r<d;++r){const u=t[r],n=e[r];if(n)continue;const a=this._lyrHandleToObjects.get(u);a&&(this._visibleGeometryChanged(),a.isVisible=n,a.components.forEach(h=>{this._collection.setObjectVisibility(h,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(h))}),this._memCache.put(`${u}`,a,a.totalMemory()))}}}_getTexture(t,e,d){var u,n;let r=null;if(t&&((u=e.desc)!=null&&u.images)&&((n=e.data)!=null&&n.buffer)){const a=e.desc.images[t==null?void 0:t.imageId];if(r=d.get(a),!r&&a){const h=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,v=!!a.mipCount||h>1,f=Vt[t.wrapMode??O.None];let g=a.alpha?4:3;const o=new Uint8Array(e.data.buffer,a.data.byteOffset,a.data.byteCount);let l=null,s=null,c=null;switch(a.format){case M.Raw:a.pixelFormat===Q.R8?(l=o,g=1,s=""):a.pixelFormat===Q.Rgb8?(l=o,g=3,s=""):a.pixelFormat===Q.Rgba8&&(l=o,g=4,s="");break;case M.Dxt1:l=o,g=3,s=xe.DDS_ENCODING;break;case M.Dxt5:l=o,g=4,s=xe.DDS_ENCODING;break;case M.Png:s="image/png",c=document.createElement("img");break;case M.Jpeg:s="image/jpeg",c=document.createElement("img");break;case M.Etc2:s="image/ktx",c=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(c&&s){const b=new Blob([o],{type:s});c.src=URL.createObjectURL(b),l=c}l&&s!=null&&(r=new pt(l,{mipmap:v,maxAnisotropy:h,encoding:s,wrap:f,components:g,noUnpackFlip:!0,width:a.mip0Width,height:a.mip0Height}),this._stage.add(r),d.set(a,r))}}return r?new It(this.view._stage.renderView.textures,r.id):null}getBufferViews(t,e,d){let r,u,n,a,h,v,f,g=null;for(let o=0;o<t.atrbs.length;o++){const l=t.atrbs[o],s=l.view,c=void 0,b=s.byteOffset+s.byteCount,m=s.byteCount/jt[s.type],w=[...Array(m).keys()].map(_=>_);try{switch(l.sem){case S.Position:s.ncomp!==3||s.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(r=new Y(e,s.byteOffset,c,b),u=new D(r.typedBuffer,w,3));break;case S.Normal:if(s.ncomp!==3||s.type!==p.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else{const _=new Y(e,s.byteOffset,c,b),T=vt(_.typedBuffer,d);h=new xt(T),v=new D(h.typedBuffer,w,2)}break;case S.TexCoord:s.ncomp!==2||s.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):a===void 0&&(a=new D(new wt(e,s.byteOffset,c,b).typedBuffer,w,2));break;case S.Color:s.ncomp===4?(s.type===p.F32&&(g=new gt(e,s.byteOffset,c,b)),s.type===p.U8&&(g=new bt(e,s.byteOffset,c,b)),s.type===p.U16&&(g=new yt(e,s.byteOffset,c,b))):s.ncomp===3&&(s.type===p.F32&&(g=new Y(e,s.byteOffset,c,b)),s.type===p.U8&&(g=new ft(e,s.byteOffset,c,b)),s.type===p.U16&&(g=new _t(e,s.byteOffset,c,b))),g==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):n=new D(g.typedBuffer,w,s.ncomp);break;case S.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+l.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const o=t.index.view,l=void 0,s=o.byteOffset+o.byteCount;switch(t.index.view.type){case p.U16:f=new Te(e,o.byteOffset,l,s);break;case p.U32:f=new Ce(e,o.byteOffset,l,s);break;case p.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+o.type+").")}}if(f==null&&r!=null){const o=r.count;if(o<65535){const l=new Uint16Array(o);f=new Te(l)}else{const l=new Uint32Array(o);f=new Ce(l)}for(let l=0;l<o;l++)f.set(l,l)}return{positionView:r,positionAttr:u,colorAttr:n,texCoord0Attr:a,indicesView:f,normalsView:h,normalsAttr:v}}_onRemoveFromCache(t){var e;(e=this._wasm)==null||e.onRenderableEvicted(this,t.handle,t.totalMemory()),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?Me.getLogger(this).error(e):Me.getLogger(this).warn(e))}};I([L()],P.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),I([L()],P.prototype,"layer",void 0),I([L({readOnly:!0})],P.prototype,"visibleAtCurrentScale",null),I([L()],P.prototype,"elevationOffset",null),P=I([Ct("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],P);const Wt=P;export{Wt as default};
