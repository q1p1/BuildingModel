import{hH as Tt,ba as I,d4 as R,d1 as wt,d2 as tt,d3 as et,ap as Bt,v as zt,d7 as z,j7 as Ut,hK as U,fe as Nt,dU as jt,dr as Vt,cN as st,cO as N,dt as lt,cM as It,bH as C,kf as Ft,kg as Gt,e as Ht,bI as Wt,kh as Zt,bM as qt,dX as Kt,ki as X,kj as Xt,kk as ht,kl as ut,km as pt,hI as Jt,bj as J,kn as Qt,ca as Yt,d6 as te,h7 as ee,bS as se,hP as ne,ko as ae,kp as ie,c6 as dt,i4 as oe,kq as re,kr as ce,ks as le,kt as he,g3 as H,e0 as gt,ku as ue,bT as Y,hZ as pe,kv as de,kw as ge,kx as me,ky as ye,g_ as fe,ii as be}from"./index-Dimyyb88.js";import{e as Ot}from"./earcut-Lltz9D9k.js";import{t as _e,e as mt}from"./SnappingCandidate-O5eRSE6e.js";import{a as xe}from"./renderingInfoUtils-BvHjVlu9.js";import{c as Se,a as Ct,p as Mt}from"./triangulationUtils-WAsFOiMf.js";function Ge(t,e,s){const a=(e.length>0?e[0]:t.length/3)-1,n=Se(t,a,s);if(n!==Tt.Z){t=t.slice();for(let i=0;i<t.length;i+=3)t[i+n]=t[i+2]}return Ot(t,e,3)}function He(t){const e=[[I.POSITION,new R(t.attributeData.position,t.indices,3,!0)]],s=wt(t.indices.length);return t.attributeData.colorFeature!=null?e.push([I.COLORFEATUREATTRIBUTE,new R([t.attributeData.colorFeature],s,1,!0)]):t.attributeData.color&&e.push([I.COLOR,new R(t.attributeData.color,s,4,!0)]),t.attributeData.uvMapSpace&&e.push([I.UVMAPSPACE,new R(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([I.BOUNDINGRECT,new R(t.attributeData.boundingRect,t.indices,9,!0)]),new tt(t.material,e,t.mapPositions,et.Mesh,t.attributeData.objectAndLayerIdColor)}function We(t,e=null){const s=[[I.POSITION,new R(t.attributeData.position,t.indices,3,!0)],[I.UV0,new R(t.attributeData.uv0,t.indices,2,!0)]];return new tt(t.material,s,t.mapPositions,et.Mesh,e)}function Pe(t){switch(t.type){case"extent":if(t instanceof Bt)return zt.fromExtent(t);break;case"polygon":return t}return null}let Ze=class{constructor(e,s,a){this.renderData=e,this.layerUid=s,this.graphicUid=a,this.outGeometries=new Array}};function Ee(t,e,s,a){const n=Ct(t.rings,!!t.hasZ&&a.mode!=="on-the-ground",Mt.CCW_IS_HOLE,t.spatialReference),i=z(n.position.length),o=Ut(n.position,t.spatialReference,0,i,0,n.position,0,n.position.length/3,e,s,a),c=o!=null;return new Oe(n.position,i,At(n.polygons,n.position,i),vt(n.outlines,n.position,i),c,o)}function Ke(t,e){const s=Ct(t.rings,!1,Mt.CCW_IS_HOLE),a=Nt(s.position,t.spatialReference,0,s.position,e,0);for(let n=2;n<s.position.length;n+=3)s.position[n]=jt;return{position:s.position,polygons:At(s.polygons,s.position),outlines:vt(s.outlines,s.position),projectionSuccess:a}}function vt(t,e,s=null){return t.filter(({count:a})=>a>1).map(({index:a,count:n})=>{const i=3*a,o=3*n;return s!=null?new Lt(a,n,U(e,i,o),U(s,i,o)):new nt(a,n,U(e,i,o))})}function At(t,e,s=null){const a=new Array;for(const{index:n,count:i,holeIndices:o,pathLengths:c}of t){if(i<=1)continue;const l=3*n,m=3*i,f=o.map(d=>d-n),g=s!=null?new we(n,i,U(e,3*n,3*i),U(s,l,m),f,c):new Ie(n,i,U(e,3*n,3*i),f,c);a.push(g)}return a}class nt{constructor(e,s,a){this.index=e,this.count=s,this.position=a}}class Lt extends nt{constructor(e,s,a,n){super(e,s,a),this.mapPositions=n}}class we extends Lt{constructor(e,s,a,n,i,o){super(e,s,a,n),this.holeIndices=i,this.pathLengths=o}}class Ie extends nt{constructor(e,s,a,n,i){super(e,s,a),this.holeIndices=n,this.pathLengths=i}}class Oe{constructor(e,s,a,n,i,o){this.position=e,this.mapPositions=s,this.polygons=a,this.outlines=n,this.projectionSuccess=i,this.sampledElevation=o}}const Ce=["polygon","extent"];class Xe extends Ft{constructor(e,s,a,n){super(e,s,a,n),this.ensureDrapedStatus(!1)}async doLoad(){var m,f,g,d;if(!this._drivenProperties.size){const S=Gt(this._getSymbolSize());if(S)throw new Ht("graphics3dextrudesymbollayer:invalid-size",S)}const e=(f=(m=this.symbolLayer)==null?void 0:m.material)==null?void 0:f.color,s=this._getCombinedOpacityAndColor(e),a=Wt(s),n=s[3],i=n<1||this.needsDrivenTransparentPass,o=(d=(g=this.symbolLayer)==null?void 0:g.material)==null?void 0:d.emissiveFactor,c=o?Zt(qt(o)):Kt,l={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:a,ambient:a,opacity:n,transparent:i,cullFace:i?X.None:X.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:c,offsetTransparentBackfaces:!0,normalType:Xt.Compressed};this._materials[A.Main]=new ht(l,this._context),this._materials[A.Bottom]=new ht({...l,cullFace:X.Back},this._context),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(e){const s=e.graphic;if(!this._validateGeometry(s.geometry,Ce,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(e.renderingInfo,255),n=this.setGraphicElevationContext(s);return this._createAs3DShape(s,e.renderingInfo,a,n,s.uid)}layerOpacityChanged(e,s){var c,l,m,f;const a=(l=(c=this.symbolLayer)==null?void 0:c.material)==null?void 0:l.color,n=this._getCombinedOpacity(a),i=n<1||this.needsDrivenTransparentPass;(m=this._materials[A.Main])==null||m.setParameters({opacity:n,transparent:i}),(f=this._materials[A.Bottom])==null||f.setParameters({opacity:n,transparent:i});const o=this._getLayerOpacity();e.forEach(g=>{var d;return(d=s(g))==null?void 0:d.layerOpacityChanged(o,this._context.isAsync)})}layerElevationInfoChanged(e,s){return this.updateGraphics3DGraphicElevationInfo(e,s,ut)}slicePlaneEnabledChanged(e,s){var a,n;return(a=this._materials[A.Main])==null||a.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),(n=this._materials[A.Bottom])==null||n.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(i=>{const o=s(i);o!=null&&o.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var s,a;const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return(s=this._materials[A.Main])==null||s.setParameters(e),(a=this._materials[A.Bottom])==null||a.setParameters(e),!0}_getExtrusionSize(e){let s;return s=e.size&&this._drivenProperties.size?xe(e.size,2)??0:this._getSymbolSize(),s/=this._context.renderCoordsHelper.unitInMeters,s}applyRendererDiff(e,s){return this._drivenPropertiesChanged(s)?pt.RecreateSymbol:pt.RecreateGraphics}async queryForSnapping(e,s,a,n){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Jt(s),{objectId:o,target:c}=e,l=J(c);switch(l.z=(l.z??0)+i,e.type){case"edge":{const{start:m,end:f}=e,g=J(m),d=J(f);return g.z=(g.z??0)+i,d.z=(d.z??0)+i,[mt(o,l,1/0,g,d)]}case"vertex":return[_e(o,l,1/0),mt(o,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,s,a,n,i){const o=Pe(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(M=>M.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const c=Ee(o,this._context.elevationProvider,this._context.renderCoordsHelper,n);this._logGeometryCreationWarnings(c,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Qt(o);if(l==null)return null;const m=new Array,f=new Array,g=Yt(),d=Y(),S=C(),h=this._context.renderCoordsHelper.viewingMode===te.Global;h||this._context.renderCoordsHelper.worldUpAtPosition(null,S),ee(o.spatialReference,[l.x,l.y,0],d,this._context.renderCoordsHelper.spatialReference);const b=Y();se(b,d);const y=pe();ne(y,b);const{polygons:x,mapPositions:p,position:_}=c,u=new Map,P=this._materials[A.Main];for(const M of x){const D=M.count;if(this._context.clippingExtent&&(ae(M.mapPositions,g),!ie(g,this._context.clippingExtent)))continue;const $=Ot(M.mapPositions,M.holeIndices,3);if($.length===0)continue;const k=$.length,T=6*D,W=dt(T+k),Z=dt(k),V=z(3*T),at=z(3*T),it=z(3*T),ot=z(T);Me(_,p,$,M,V,it,at,ot,W,Z,this._getExtrusionSize(s),S,h),oe(V,V,b);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),q=new Be(V,it,re(at),ot),K=yt(P,W,W.length-Z.length,q,a,rt),Dt=D,$t=D,kt=2*M.count,ct=new ze(Dt,$t,kt,k/3);Rt(K,ct,d),u.set(K,ct),m.push(K,yt(this._materials[A.Bottom],Z,0,q,a,rt)),f.push(q.heights)}if(m.length===0)return null;const r=new ce({geometries:m,layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0});r.transformation=d;const E=le(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=E?new he(this._materials[A.Main],E,this._context.slicePlaneEnabled):null,L=new de(this,r,m,null,null,(M,D,$,k,T)=>Le(M,D,$,k,T,f,u),n,w);return L.alignedSampledElevation=c.sampledElevation,L.needsElevationUpdates=ut(n.mode),L}}function yt(t,e,s,a,n,i){const o=wt(e.length),c=[[I.POSITION,new R(a.positions,e,3,!0)],[I.NORMALCOMPRESSED,new R(a.normals,e,2,!0)],[I.COLOR,new R(n,o,4,!0)]];return new tt(t,c,a.elevation,et.Mesh,i,s)}function Me(t,e,s,a,n,i,o,c,l,m,f,g,d){{const S=s.length/3,h=2*a.count;ve(t,e,a.index,a.count,s,0,S,n,i,o,c,l,m,h,f,g,d)}{let S=0,h=2*a.count,b=0;const y=a.pathLengths[0];ft(n,i,c,o,S,y,a.count,h,l,b,f),h+=4*y,b+=2*y,S+=y;for(let x=1;x<a.pathLengths.length;++x){const p=a.pathLengths[x];ft(n,i,c,o,S,p,a.count,h,l,b,f),h+=4*p,b+=2*p,S+=p}}}function ve(t,e,s,a,n,i,o,c,l,m,f,g,d,S,h,b,y){Vt(v,b);{const x=h>0?1:-1;let p=3*s,_=0,u=3*_,P=a,r=3*P;for(let E=0;E<a;++E){const w=t[p],L=t[p+1],M=t[p+2];y&&(v[0]=w,v[1]=L,v[2]=M,st(v,v)),c[u+0]=w,c[u+1]=L,c[u+2]=M;const D=e[p+0],$=e[p+1],k=e[p+2];l[u+0]=D,l[u+1]=$,l[u+2]=k,m[u+0]=-x*v[0],m[u+1]=-x*v[1],m[u+2]=-x*v[2],f[_]=0,c[r+0]=w+h*v[0],c[r+1]=L+h*v[1],c[r+2]=M+h*v[2],l[r+0]=D,l[r+1]=$,l[r+2]=k,f[P]=h,u+=3,r+=3,p+=3,_+=1,P+=1}}{let x=3*i,p=0,_=3*S;const u=h<0?Et:Pt,P=h<0?Pt:Et;for(let r=0;r<o;++r)d[p]=n[x+u[0]],d[p+1]=n[x+u[1]],d[p+2]=n[x+u[2]],g[_]=n[x+P[0]]+a,g[_+1]=n[x+P[1]]+a,g[_+2]=n[x+P[2]]+a,p+=3,_+=3,x+=3}}function F(t,e,s,a,n,i,o){a[i]=a[o],o*=3,t[i*=3]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],e[i]=e[o],e[i+1]=e[o+1],e[i+2]=e[o+2],s[i]=n[0],s[i+1]=n[1],s[i+2]=n[2]}const j=C();function ft(t,e,s,a,n,i,o,c,l,m,f){let g=n,d=n+1,S=n+o,h=n+o+1,b=c,y=c+1,x=c+2*i,p=c+2*i+1;f<0&&(g=n+o+1,h=n);let _=3*m;for(let u=0;u<i;++u)u===i-1&&(d=n,f>0?h=n+o:g=n+o),Ae(t,g,d,S,j),F(t,e,a,s,j,b,g),F(t,e,a,s,j,y,d),F(t,e,a,s,j,x,S),F(t,e,a,s,j,p,h),l[_]=b,l[_+1]=x,l[_+2]=p,l[_+3]=b,l[_+4]=p,l[_+5]=y,_+=6,g++,d++,S++,h++,b+=2,y+=2,x+=2,p+=2}const Q=C(),bt=C(),_t=C(),xt=C(),St=C();function Ae(t,e,s,a,n){e*=3,s*=3,a*=3,N(Q,t[e++],t[e++],t[e++]),N(bt,t[s++],t[s++],t[s++]),N(_t,t[a++],t[a++],t[a++]),lt(xt,bt,Q),lt(St,_t,Q),It(n,St,xt),st(n,n)}const B=C();function Le(t,e,s,a,n,i,o){const c=t.stageObject,l=c.geometries,m=l.length,f=e.mode!=="absolute-height";let g=0;const d=c.transformation,S=ge(Y(),d);for(let h=0;h<m;h+=2){const b=l[h];if(!me(b))continue;const y=b.getMutableAttribute(I.POSITION).data,x=i[h/2],p=new ye(b.mapPositions),_=y.length/3;let u=!1,P=0;{let r=0;for(let E=0;E<_;E++){B[0]=y[r],B[1]=y[r+1],B[2]=y[r+2],a(p,G),f&&(P+=G.sampledElevation),fe.TESTS_DISABLE_OPTIMIZATIONS?(N(O,p.array[p.offset],p.array[p.offset+1],G.z+x[r/3]),s!=null&&n.toRenderCoords(O,s,O),H(O,O,S)):(N(O,y[r],y[r+1],y[r+2]),H(O,O,d),n.setAltitude(O,G.z+x[r/3]),H(O,O,S)),y[r]=O[0],y[r+1]=O[1],y[r+2]=O[2];const w=Re/n.unitInMeters;(Math.abs(B[0]-y[r])>=w||Math.abs(B[1]-y[r+1])>=w||Math.abs(B[2]-y[r+2])>=w)&&(u=!0),p.offset+=3,r+=3}}if(u){const r=o.get(b);r&&Rt(b,r,d),c.geometryVertexAttributeUpdated(l[h],I.NORMALCOMPRESSED),b.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[h],I.POSITION),l[h+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[h+1],I.POSITION)}g+=P/_}return g/m}function Rt(t,e,s){const a=t.getMutableAttribute(I.POSITION),n=t.getMutableAttribute(I.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:o,topFaceStart:c,topFaceCount:l}=e,m=a.data,f=o,g=t.attributes.get(I.POSITION).indices,d=c+l,S=i+o,h=z(3*f);for(let u=0;u<f;++u){const P=3*u;h[P+0]=0,h[P+1]=0,h[P+2]=0}const b=De,y=$e,x=ke,p=Te,_=v;for(let u=c;u<d;++u){const P=3*u;for(let r=0;r<3;++r){const E=g[P+r];p[r]=E;const w=3*E;N(O,m[w+0],m[w+1],m[w+2]),H(b[r],O,s)}gt(y,b[1],b[0]),gt(x,b[2],b[0]),It(_,y,x),st(_,_);for(let r=0;r<3;++r){const E=3*(p[r]-i);h[E+0]+=_[0],h[E+1]+=_[1],h[E+2]+=_[2]}}for(let u=i;u<S;++u){const P=3*(u-i),r=h[P+0],E=h[P+1],w=h[P+2],L=Math.sqrt(r*r+E*E+w*w);ue(n,u,r/L,E/L,w/L)}}const O=C(),v=C(),G=new be,Pt=[0,2,1],Et=[0,1,2],Re=.01,De=[C(),C(),C()],$e=C(),ke=C(),Te=[0,0,0];var A;(function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"})(A||(A={}));class Be{constructor(e,s,a,n){this.positions=e,this.elevation=s,this.normals=a,this.heights=n}}class ze{constructor(e,s,a,n){this.topVertexStart=e,this.topVertexCount=s,this.topFaceStart=a,this.topFaceCount=n}}export{Ge as a,Pe as b,Ke as c,Ze as g,We as l,He as m,Me as n,Xe as o,Ee as p};
