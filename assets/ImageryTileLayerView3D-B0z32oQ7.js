import{mR as G,mS as E,mT as M,mU as $,mV as b,h3 as S,mW as v,mX as F,mY as p,mZ as V,r as d,m as c,a as j,e as N,L as W,aY as k,m_ as Z}from"./index-jYn0Tv9l.js";import{j as J,c as z}from"./rasterProjectionHelper-Ct6u5zpk.js";import{l as q}from"./LayerView3D-DBt_Ivop.js";import{p as H}from"./TiledLayerView3D-DL17LR_Z.js";import{i as Y}from"./timeSupport-BrShVteU.js";import{p as Q}from"./popupUtils-B7JocjtR.js";import{y as X}from"./LayerView-Cjdo7uGO.js";import{i as K}from"./RefreshableLayerView-DzPikRPm.js";import{r as ee}from"./drapedUtils-DSWo0VRq.js";import"./utils-D1nUM6a_.js";function te(r,e,t="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?G.FLOAT:G.UNSIGNED_BYTE,h=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),m=r.capabilities.textureFloatLinear,a=new E;return a.width=e.width,a.height=e.height,a.internalFormat=s?M.RGBA32F:$.RGBA,a.samplingMode=!m||t!=="bilinear"&&t!=="cubic"?b.NEAREST:b.LINEAR,a.dataType=n,a.wrapMode=S.CLAMP_TO_EDGE,new v(r,a,h)}function re(r,e){const{spacing:t,offsets:i,coefficients:s,size:[n,h]}=e,m=t[0]>1,a=new E;a.width=m?4*n:n,a.height=h,a.internalFormat=M.RGBA32F,a.dataType=G.FLOAT,a.samplingMode=b.NEAREST,a.wrapMode=S.CLAMP_TO_EDGE;const l=new Float32Array(m?n*h*16:2*i.length);if(m&&s!=null)for(let u=0,o=0;u<s.length;u++)l[o++]=s[u],u%3==2&&(l[o++]=1);else for(let u=0;u<h;u++)for(let o=0;o<n;o++){const _=4*(u*n+o),x=2*(o*h+u);l[_]=i[x],l[_+1]=i[x+1],l[_+3]=i[x]===-1?0:1}return new v(r,a,l)}function L(r,e){const t=new E;return t.internalFormat=$.RGBA,t.width=e.length/4,t.height=1,t.samplingMode=b.NEAREST,t.wrapMode=S.CLAMP_TO_EDGE,new v(r,t,e)}function ie(r,e,t,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!r,u_opacity:i,u_transformSpacing:r?r.spacing:F,u_transformGridSize:r?r.size:F,u_targetImageSize:e,u_srcImageSize:t}}function se(r,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:r?r.length/4-1:0}}function ae(r){return{u_bandCount:r.bandCount,u_minOutput:r.outMin,u_maxOutput:r.outMax,u_minCutOff:r.minCutOff,u_maxCutOff:r.maxCutOff,u_factor:r.factor,u_useGamma:r.useGamma,u_gamma:r.gamma,u_gammaCorrection:r.gammaCorrection}}function ne(r){return{u_hillshadeType:r.hillshadeType,u_sinZcosAs:r.sinZcosAs,u_sinZsinAs:r.sinZsinAs,u_cosZs:r.cosZs,u_weights:r.weights,u_factor:r.factor,u_minValue:r.minValue,u_maxValue:r.maxValue}}const C={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class le{constructor(e,t,i=null,s=null){this.lij=e,this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.opacity=1,this.source=t,this.width=i||t.width,this.height=s||t.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=p(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...C,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||C}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((t,i)=>{var s;return!!((s=this._bandIds)!=null&&s[i])&&t===this._bandIds[i]})||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const t=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(t==="bilinear"?b.LINEAR:b.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=p(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=re(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:t,width:i,height:s,opacity:n}=this,h=ie(t,[i,s],[this.source.width,this.source.height],n),m=se(e.colormap,e.colormapOffset),a=this.symbolizerParameters.type==="stretch"?ae(this.symbolizerParameters):null,l=this.symbolizerParameters.type==="hillshade"?ne(this.symbolizerParameters):null;return new V(h,m,a||l,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(t=>t!=null?t.descriptor.width*t.descriptor.height*4:0).reduce((t,i)=>t+i,0)}return this._memoryUsed}release(){return this._rasterTexture=p(this._rasterTexture),this._transformGridTexture=p(this._transformGridTexture),this._colormapTexture=p(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,t){const i=this.source?this.source.extractBands(t):null;if(!(i!=null&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=p(this._rasterTexture));const s=t==null&&this.bandIds==null||t!=null&&this.bandIds!=null&&t.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=p(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=te(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const t=this._colormap,i=this.symbolizerParameters.colormap;return i?t?i.length!==t.length||i.some((s,n)=>s!==t[n])?(this._colormapTexture=p(this._colormapTexture),this._colormapTexture=L(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=L(e,i),void(this._colormap=i)):(this._colormapTexture=p(this._colormapTexture),void(this._colormap=null))}}const oe=r=>{let e=class extends r{constructor(){super(...arguments),this._rasterFieldPrefix="Raster.",this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var t;return Y(this.layer,(t=this.view)==null?void 0:t.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){return!!(this.layer.renderer&&"dynamicRangeAdjustment"in this.layer.renderer&&this.layer.renderer.dynamicRangeAdjustment)}get datumTransformation(){try{return this.layer.loaded?J(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(t){try{return!this.layer.loaded||!!z(this.layer.serviceRasterInfo,t)}catch{return!1}}async fetchPopupFeaturesAtLocation(t,i){var _,x;const{layer:s}=this;if(!t)throw new N("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const{popupEnabled:n}=s,h=Q(s,i);if(!n||h==null)return[];const m=[],{value:a,magdirValue:l,processedValue:u}=await s.identify(t,{timeExtent:this.timeExtent,signal:i==null?void 0:i.signal});let o="";if(a!=null&&a.length){o=s.type==="imagery-tile"&&s.hasStandardTime()&&a[0]!=null?a.map(w=>s.getStandardTimeValue(w)).join(", "):a.join(", ");const y={ObjectId:0},R="Raster.ServicePixelValue";y[R]=s.type==="imagery-tile"&&s.raster.datasetFormat==="Function"?u==null?void 0:u.join(", "):o,y[R+".Raw"]=o;const T=((_=s.raster)==null?void 0:_.rasterInfo)??s.serviceRasterInfo,P=T==null?void 0:T.attributeTable;if(P!=null){const{fields:w,features:B}=P,O=w.find(({name:f})=>f.toLowerCase()==="value"),D=y[R],I=O?B.find(f=>String(f.attributes[O.name])===D):null;if(I)for(const f in I.attributes)I.attributes.hasOwnProperty(f)&&(y[this._rasterFieldPrefix+f]=I.attributes[f])}const A=T==null?void 0:T.dataType;A!=="vector-magdir"&&A!=="vector-uv"||(y["Raster.Magnitude"]=l==null?void 0:l[0],y["Raster.Direction"]=l==null?void 0:l[1]);const U=new W({geometry:(x=this.fullExtent)==null?void 0:x.clone(),attributes:y,layer:s,sourceLayer:s});m.push(U)}return m}_getFullExtent(){return z(this.layer.serviceRasterInfo,this.view.spatialReference)}};return d([c()],e.prototype,"fullExtent",null),d([c()],e.prototype,"layer",void 0),d([c({readOnly:!0})],e.prototype,"timeExtent",null),d([c()],e.prototype,"tileInfo",void 0),d([c({readOnly:!0})],e.prototype,"hasTilingEffects",null),d([c()],e.prototype,"datumTransformation",null),e=d([j("esri.views.layers.ImageryTileLayerView")],e),e};let g=class extends oe(K(H(q(X)))){constructor(){super(...arguments),this.type="imagery-tile-3d",this._isAlignedMapTile=!0}initialize(){this.layer.increaseRasterJobHandlerUsage(),this.fullExtent==null&&this.addResolvingPromise(Promise.reject(new N("layerview:spatial-reference-incompatible","The layer extent cannot be projected to the view's spatial reference",{layer:this.layer})));const r=k(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.basemapTerrain)==null?void 0:t.tilingSchemeLocked}).then(()=>{const e=this.view.basemapTerrain.tilingScheme,t=this.layer.tileInfo;this._isAlignedMapTile=["png","png24","png32","jpg","mixed"].includes(t.format)&&e.compatibleWith(t),this.tileInfo=this._isAlignedMapTile?t:e.toTileInfo(),this._updatingHandles.add(()=>[this.layer.renderer,this.layer.interpolation,this.layer.bandIds,this.layer.multidimensionalDefinition,this.layer.multidimensionalSubset,this.layer.rasterFunction,this.timeExtent],()=>this.refresh())});this.addResolvingPromise(r)}destroy(){this.layer.decreaseRasterJobHandlerUsage()}get _blankTile(){const r=document.createElement("canvas"),e=r.getContext("2d"),[t,i]=this.tileInfo.size;return r.width=t,r.height=i,e.clearRect(0,0,t,i),e.getImageData(0,0,t,i)}get imageFormatIsOpaque(){return this.layer.tileInfo.format==="jpg"}get hasMixedImageFormats(){return this.layer.tileInfo.format==="mixed"}get dataLevelRange(){var i,s;const r=this.layer.tileInfo,e=(i=this.tileInfo.lodAt(0))==null?void 0:i.scale,t=(s=this.layer.tileInfo.lodAt(r.lods.length-1))==null?void 0:s.scale;return this.levelRangeFromScaleRange(e,t)}_getFullExtent(){var r;return z(this.layer.serviceRasterInfo,((r=this.view.basemapTerrain)==null?void 0:r.spatialReference)??this.view.spatialReference)}async fetchTile(r,e){const t=this.tileInfo,i=this._canSymbolizeInWebGL(),s={tileInfo:t,requestRawData:i,signal:e.signal,timeExtent:this.timeExtent,requestAsImageElement:this._isAlignedMapTile,noClip:!1},{layer:n}=this,[h,m,a]=r,l=await n.fetchTile(h,m,a,s);if(l instanceof HTMLImageElement)return l;let u=l==null?void 0:l.pixelBlock;if(u==null)return this._blankTile;if(!i&&(u=await n.applyRenderer(l),u==null))return this._blankTile;const o=new le([h,m,a],u,t.size[0],t.size[1]);return i?(o.symbolizerRenderer=n.symbolizer.rendererJSON,o.symbolizerParameters=n.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(h)),o.transformGrid=l.transformGrid,o.bandIds=n.bandIds):(o.isRendereredSource=!0,o.bandIds=null),o.interpolation=n.interpolation,o}_getSymbolizerOptions(r){var t;const e=this.tileInfo.lodAt(r).resolution;return{pixelBlock:null,isGCS:((t=this.view.basemapTerrain)==null?void 0:t.spatialReference)!=null?this.view.basemapTerrain.spatialReference.isGeographic:this.view.spatialReference.isGeographic,resolution:{x:e,y:e},bandIds:this.layer.bandIds}}ensureSymbolizerParameters(r){this._canSymbolizeInWebGL()&&JSON.stringify(r.symbolizerRenderer)!==JSON.stringify(this.layer.symbolizer.rendererJSON)&&(r.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(r.lij[0])))}createFetchPopupFeaturesQueryGeometry(r,e){return ee(r,e,this.view)}refresh(){this.emit("data-changed")}async doRefresh(){this.suspended||this.emit("data-changed")}_canSymbolizeInWebGL(){var n,h,m;const r=Z(),{symbolizer:e}=this.layer,t=(h=(n=e.lookup)==null?void 0:n.colormapLut)==null?void 0:h.indexedColormap,i=!!((m=this.layer.rasterFunction)!=null&&m.hasClipFunction),s=t&&t.length>4*(r.maxTextureSize||4906);return e.canRenderInWebGL&&!s&&!i}};d([c({readOnly:!0})],g.prototype,"_blankTile",null),d([c({readOnly:!0})],g.prototype,"imageFormatIsOpaque",null),d([c({readOnly:!0})],g.prototype,"hasMixedImageFormats",null),d([c({readOnly:!0})],g.prototype,"dataLevelRange",null),g=d([j("esri.views.3d.layers.ImageryTileLayerView3D")],g);const xe=g;export{xe as default};
