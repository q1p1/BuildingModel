import{bH as v,bK as Te,bm as Ae,dF as g,dH as te,dr as ie,cN as He,dt as Ie,dI as N,dJ as Z,dL as re,E as Pe,dM as je,dz as Fe,is as ke,cv as Ve,ba as F,di as ne,dU as se,dN as ae,cC as k,db as Ne,cw as C,cz as B,dn as Oe,d$ as Ze,ct as Ue,jQ as S,pg as ye,jT as K,kK as Le,kN as U,$ as oe,ph as qe,cK as We,d7 as le,j7 as Be,pi as ce,ih as Ke,cO as Qe,ki as ue,pj as Je,cQ as we,pk as Se,pl as Xe,R as L,iE as be,gU as Ye,fV as De,r as b,m as G,a as et,b as tt}from"./index-Dimyyb88.js";import{f as it,z as rt,Z as nt}from"./TextOverlayItem-BVhoD0NA.js";import{m as st,f as at,u as ot}from"./geodesicLengthMeasurementUtils-BxgrrcZU.js";import{i as lt}from"./viewUtils-CJX6HEhG.js";import{G as ct,M as ut}from"./ExtendedLineVisualElement-kaHXIrGy.js";import{t as dt}from"./EngineVisualElement-CHiGmDV6.js";import{S as de}from"./LaserlinePath.glsl-CE6MZOop.js";import{D as ht}from"./RightAngleQuadVisualElement-BGRXcXAl.js";import{D as pt,F as q,G as ft,H as mt,T as he,x as f,b as _t,I as gt,K as vt,L as V}from"./SnappingManagerPool-BukTw-xv.js";import{n as xt}from"./PointSnappingHint-DZ69mXEa.js";import{b as Pt}from"./LineVisualElement-Dldv1WW3.js";import{b as pe,w as Ot}from"./ShadedColorMaterial.glsl-CrvJAAqx.js";import{a as yt}from"./dehydratedFeatureComparison-BstjLkm-.js";function Jt(i){return st(i)??it(i)}function Xt(i,e){return at(i,e)??rt(i,e)}function Yt(i,e,t){return D[0]=i[0],D[1]=i[1],D[2]=i.length===3?i[2]:0,R[0]=e[0],R[1]=e[1],R[2]=e.length===3?e[2]:0,ot(D,R,t)??nt(D,R,t)}const D=v(),R=v();let wt=class extends dt{constructor(e){super(e),this._location=v(),this._direction=Te(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Ae(1,0,1,1),this._renderOccluded=g.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:St,recreateGeometry:(t,r)=>this._recreateObject3DGeometry(t,r),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:bt,recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){te(this._location,e)||(ie(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){te(this._direction,e)||(ie(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){He(this._direction,Ie(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){N(e,this._color)||(Z(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new re(this.materialParameters),r=new Array;return this._createObject3DGeometry(t,e,r),{material:t,geometries:r,forEach:s=>{s(t),r.forEach(s)}}}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,r){const[s,n]=fe(e);t.addGeometry(s),t.addGeometry(n),r.push(s),r.push(n),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new re(this.materialParameters),t=Pe(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=fe(e);return this._updateVerticesDraped(t),t.map(r=>new je(r))}_updateMaterial(){var t,r;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(r=this.drapedResources.resources)==null||r.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,M),Fe(_,this.location,this.direction),t.projectToScreen(_,O),ke(O,Ve(O,O,M)),this._updateVertexAttributesObject3D(t,e,0,M,O,1),this._updateVertexAttributesObject3D(t,e,1,M,O,-1)}_updateVertexAttributesObject3D(e,t,r,s,n,a){var h;const o=t.geometries[r],l=(h=o.getMutableAttribute(F.POSITION))==null?void 0:h.data;if(!l)return;const{start:c,end:u}=me(n,s,a,this.offset,this.width,this.length);e.unprojectFromScreen(ne(c),_),l[0]=_[0],l[1]=_[1],l[2]=_[2],e.unprojectFromScreen(ne(u),_),l[3]=_[0],l[4]=_[1],l[5]=_[2],t.geometryVertexAttributeUpdated(o,F.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:r}}}=this,{location:s,width:n,length:a,offset:o}=this,l=Dt;l.spatialReference=t.renderer.spatialReference,l.x=s[0],l.y=s[1];const c=this.view.overlayPixelSizeInMapUnits(l)*r,u=n*c,h=a*c,d=o*c;this._updateVertexAttributesDraped(e[0],u,h,d,-1),this._updateVertexAttributesDraped(e[1],u,h,d,1)}_updateVertexAttributesDraped(e,t,r,s,n){var h;const a=(h=e.getMutableAttribute(F.POSITION))==null?void 0:h.data;if(!a)return;const{location:o,direction:l}=this,{start:c,end:u}=me(l,o,n,s,t,r);a[0]=c[0],a[1]=c[1],a[2]=se,a[3]=u[0],a[4]=u[1],a[5]=se,e.invalidateBoundingInfo()}};function fe(i){return[ae(i,[v(),v()]),ae(i,[v(),v()])]}function me(i,e,t,r,s,n){const a=k(_e,Ne(_e,i[1]*t,i[0]*-t),r+s/2),o=C(E,C(E,C(E,e,k(E,i,n/2)),a),a);return{start:o,end:C(ge,o,k(ge,i,-n))}}function St(i){i.geometries.length=0}function bt(i){i.pixelRatioHandle.remove(),i.geometries=[]}const _=v(),_e=B(),E=B(),ge=B(),M=Oe(),O=Oe(),Dt=Ze(0,0,void 0,null);class Rt{draw(e,t){const r=$t(e),s=this.sortUniqueHints(r),n=[];for(const a of s)a instanceof pt&&n.push(this.visualizeIntersectionPoint(a,t)),a instanceof q&&n.push(this.visualizeLine(a,t)),a instanceof ft&&n.push(this.visualizeParallelSign(a,t)),a instanceof mt&&n.push(this.visualizeRightAngleQuad(a,t)),a instanceof xt&&n.push(this.visualizePoint(a,t));return Ue(n)}sortUniqueHints(e){return e}}function $t(i){const e=[];for(const t of i){let r=!0;for(const s of e)if(t.equals(s)){r=!1;break}r&&e.push(t)}return e}class ti extends Rt{sortUniqueHints(e){return e.sort((t,r)=>(r instanceof q?r.length:0)-(t instanceof q?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:r,view:s}=t,n=$(t);return S(new de({view:s,primitive:"circle",geometry:he(e.intersectionPoint,r),elevationInfo:e.isDraped?ye:K,size:20,outlineSize:2,color:n.intersectionPointColor,outlineColor:n.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:r,spatialReference:s}=t,n=$(t),a=x(e.point,e.domain,t);return S(new de({view:r,primitive:"circle",geometry:he(a,s),elevationInfo:T(e),size:20,outlineSize:2,color:n.pointColor,outlineColor:n.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:r,spatialReference:s}=t,n=$(t),a=x(e.lineStart,e.domain,t),o=x(e.lineEnd,e.domain,t);return S(zt(e.type,a,o,s,T(e),r,n,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:r,spatialReference:s}=t,n=$(t),{isDraped:a}=e,o=T(e),l=x(e.lineStart,e.domain,t),c=x(e.lineEnd,e.domain,t),u=P(l,s,o,r,a),h=P(c,s,o,r,a),d=Le(h,u,h,.5),p=new wt({view:r,attached:!1,offset:f.parallelLineHintOffset,length:f.parallelLineHintLength,width:f.parallelLineHintWidth,color:n.parallelSignColor,location:d,renderOccluded:a?g.OccludeAndTransparent:g.Opaque,isDraped:a,renderGroup:U.SnappingHint,isDecoration:!0});return p.setDirectionFromPoints(u,d),p.attached=!0,S(p)}visualizeRightAngleQuad(e,t){const{view:r,spatialReference:s}=t,n=$(t),a=T(e),{isDraped:o}=e,l=x(e.previousVertex,e.domain,t),c=x(e.centerVertex,e.domain,t),u=x(e.nextVertex,e.domain,t),h=P(l,s,a,r,o),d=P(c,s,a,r,o),p=P(u,s,a,r,o);return S(new ht({view:r,attached:!0,color:o?n.rightAngleColorDraped:n.rightAngleColor,renderOccluded:o?g.OccludeAndTransparent:g.Transparent,outlineRenderOccluded:o?g.OccludeAndTransparent:g.Opaque,outlineColor:n.rightAngleOutlineColor,outlineSize:f.rightAngleHintOutlineSize,size:f.rightAngleHintSize,isDraped:o,geometry:{previous:h,center:d,next:p},renderGroup:U.SnappingHint,isDecoration:!0}))}}function $(i){const{effectiveTheme:e}=i.view,t=oe.toUnitRGBA(e.accentColor),r=[0,0,0,0];return{intersectionPointColor:r,intersectionPointOutlineColor:t,pointColor:r,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:oe.toUnitRGBA(qe(e.accentColor,.5)),rightAngleOutlineColor:t}}function x(i,e,{selfSnappingZ:t,view:r,spatialReference:s}){return e&_t.SELF&&gt(i)&&t!=null?vt(i,t,r,s):i}function T(i){return i.isDraped?ye:K}function zt(i,e,t,r,s,n,a,o=!1,l=!0,c=!0){const u=P(e,r,s,n,o),h=P(t,r,s,n,o),d=new ct({view:n,extensionType:ut.FADED,start:u,end:h,isDraped:o,color:a.lineColor,renderOccluded:o?g.OccludeAndTransparent:g.Opaque,renderGroup:U.SnappingHint,isDecoration:!0});switch(i){case V.TARGET:d.width=f.lineHintWidthTarget,d.fadedExtensions={start:0,end:f.lineHintFadedExtensions};break;case V.REFERENCE_EXTENSION:d.width=f.lineHintWidthReference,d.fadedExtensions={start:0,end:0};break;case V.REFERENCE:d.width=f.lineHintWidthReference,d.fadedExtensions={start:l?f.lineHintFadedExtensions:0,end:c?f.lineHintFadedExtensions:0}}return d.attached=!0,d}function P(i,e,t,r,s){const n=v();if(s){const a=r.basemapTerrain.overlayManager.renderer.spatialReference;We(i,e,n,a)}else lt(i,e,t,r,n);return n}function Ct(i,e,t,r,s){const n=le(3*i.length),a=le(n.length);i.forEach((c,u)=>{n[3*u]=c[0],n[3*u+1]=c[1],n[3*u+2]=c.length>2?c[2]:0});const o=Be(n,e,0,a,0,n,0,n.length/3,t,r,s),l=o!=null;return{numVertices:i.length,position:n,mapPositions:a,projectionSuccess:l,sampledElevation:o}}let ii=class extends Pt{constructor(e){super(e),this.view=null,this._renderOccluded=g.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=ce([1,127/255,0,1]),this._size=11,this._outlineColor=ce([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){N(e,this._color)||(Z(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){N(e,this._outlineColor)||(Z(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,r=.5,s=Ct(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Ke.fromElevationInfo(this.elevationInfo)),n=[],a=s.numVertices,o=s.position;for(let l=0;l<a;++l){const c=Qe(Gt,o[3*l],o[3*l+1],o[3*l+2]),u=ve(this._vertexMaterial,t,c),h=ve(this._vertexOutlineMaterial,r,c);n.push({vertexGeometry:u,vertexOutlineGeometry:h})}return n}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:r,vertexOutlineGeometry:s}of t)e.addGeometry(r),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new pe({...this._vertexMaterialParameters,writeDepth:!0,cullFace:ue.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new pe({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:ue.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Gt=v();function ve(i,e,t){return Je(i,e,16,16,{offset:t})}class Et{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.drawConstraints=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.feature=e.feature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ,this.drawConstraints=e.drawConstraints}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function ni({predicate:i=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:r,useZ:s=!0}){const n=new Ot;if(e==null)return{snappingStep:[xe,n],cancelSnapping:xe};let a,o=null,l=null,c=null;const u=()=>{o=L(o),e.doneSnapping(),l==null||l.frameTask.remove(),l=null,a=be(a),c=null},h=Mt(e,s,n);let d=null,p=null,Q=null;return{snappingStep:[m=>{if(!i(m))return m;const{action:A}=m;if(A==="start"){const{info:z}=m,H=Tt(e.view);if(l=At(t,m,H),l.context.selfSnappingZ=null,!s&&z!=null){const w=It(t.coordinateHelper,z.handle.component);w!=null&&(l.context.selfSnappingZ={value:w,elevationInfo:t.elevationInfo??K})}}if(l!=null){const{context:z,originalScenePos:H,originalPos:w}=l,{mapEnd:J,mapStart:X,scenePoints:ze}=m,I=Re(w,W(J,X)),Y=W(X,w),Ce={...m,action:"update"},Ge=l.context,j=Ht(H,ze),ee=e.update({point:I,scenePoint:j,context:z});if(Q=ee,$e(J,ee,Y,s),d=I,p=j,A!=="end"){const{frameTask:Ee}=l;o==null&&(o=new AbortController),c=Me=>{r.addPromise(Ye(h({frameTask:Ee,event:Ce,context:Ge,point:I,scenePoint:j,delta:Y,getLastState:()=>({point:d,scenePoint:p,updatePoint:Me.forceUpdate?null:Q})},o.signal)))},c({forceUpdate:!1}),a==null&&(a=Pe(()=>e.options.effectiveEnabled,()=>c==null?void 0:c({forceUpdate:!0})))}}return A==="end"&&u(),m},n],cancelSnapping:m=>(u(),m)}}function Mt(i,e,t){return De(async({frameTask:r,point:s,scenePoint:n,context:a,event:o,delta:l,getLastState:c},u)=>{const h=await r.schedule(()=>i.snap({point:s,scenePoint:n,context:a,signal:u}),u);if(h.valid){let d=await r.schedule(()=>h.apply(),u);const p=c();p.point!=null&&s!==p.point&&(d=i.update({point:p.point,scenePoint:p.scenePoint,context:a})),p.updatePoint!=null&&yt(d,p.updatePoint)||($e(o.mapEnd,d,l,e),t.execute(o))}})}function Tt(i){return i.type==="3d"?i.resourceController.scheduler.registerTask(we.SNAPPING):Se}function At(i,e,t){return{context:new Et({editGeometryOperations:i.editGeometryOperations,elevationInfo:i.elevationInfo,pointer:i.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:i.excludeFeature,feature:i.feature,visualizer:i.visualizer}),originalPos:e.snapOrigin!=null?i.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:t}}function Re(i,[e,t,r]){const s=Xe(i);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=r),s}function Ht(i,e){return i==null||e==null?null:Re(i,W(e.sceneEnd,e.sceneStart))}function W(i,e){const t=i.hasZ&&e.hasZ?i.z-e.z:0;return[i.x-e.x,i.y-e.y,t]}function $e(i,e,[t,r,s],n){i.x=e.x+t,i.y=e.y+r,n&&i.hasZ&&e.hasZ&&(i.z=e.z+s)}function It(i,e){if(!i.hasZ())return null;const t=e.vertices;let r=null;for(const s of t){const n=i.getZ(s.pos);if(r!=null&&n!=null&&Math.abs(n-r)>1e-6)return null;r==null&&(r=n)}return r}function xe(i){return i}let y=class extends tt{constructor(i){super(i),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=De(async(e,t,r,s)=>{const n=this._frameTask;if(n==null)return;const a=await n.schedule(()=>t.snap({...e,context:r,signal:s}),s);a.valid&&await n.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=t.update({...this._snapPoints,context:r}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(i){this._stagedPoint=this.constrainResult(i)}initialize(){var e,t;const i=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=i!=null?i.registerTask(we.SNAPPING):Se}destroy(){this._abortController=L(this._abortController),this._frameTask=be(this._frameTask)}update(i,e,t){this._snapPoints=i;const{point:r,scenePoint:s}=i,n=e.update({point:r,scenePoint:s,context:t});return this.stagedPoint=n,n}async snap(i,e,t){const{point:r,scenePoint:s}=i;return this.stagedPoint=e.update({point:r,scenePoint:s,context:t}),this._snapPoints=i,this._abortController==null&&(this._abortController=new AbortController),this._snap(i,e,t,this._abortController.signal)}async snapAgainNearPreviousMapPoint(i,e){this._snapPoints!=null&&await this.snap(this._snapPoints,i,e)}abort(){this._abortController=L(this._abortController),this._snapPoints=null}};b([G({constructOnly:!0})],y.prototype,"view",void 0),b([G()],y.prototype,"stagedPoint",null),b([G()],y.prototype,"constrainResult",void 0),b([G()],y.prototype,"_stagedPoint",void 0),y=b([et("esri.views.interactive.snapping.SnappingOperation")],y);export{ti as R,Jt as c,ii as d,Et as e,ni as f,Xt as m,y as p,Yt as u};
